services:
  runtipi-reverse-proxy:
    image: traefik:v3.2.2
    #environment:
      #TRAEFIK_CERTIFICATESRESOLVERS_myresolver_ACME_EMAIL: ${ACME_EMAIL}
    ports:
      - 8080:8080
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./user-config/traefik/etc:/etc/traefik
      - ./app-data/traefik/plugins-local:/plugins-local
      - ./app-data/traefik/shared:/shared

  runtipi:
    labels:
      # ---- General ----- #

      # ---- Dashboard ----- #
      # Local ip
      traefik.http.routers.dashboard.rule: (Host(`${INTERNAL_IP}`) || Host(`tipi.${LOCAL_DOMAIN}`)) && PathPrefix(`/`)
      # Websecure
      traefik.http.routers.dashboard-secure.middlewares: plugin-geoblock@file, forwardAuth-authentik@file
      # Secure
      traefik.http.routers.dashboard-local.middlewares: ipAllowList-local@file

      # ---- Socket ----- #
      # Local ip
      traefik.http.routers.socket.rule: (Host(`${INTERNAL_IP}`) || Host(`tipi.${LOCAL_DOMAIN}`)) && PathPrefix(`/api/socket.io`)
      # Websecure
      traefik.http.routers.socket-insecure.rule: Host(`${DOMAIN}`) && PathPrefix(`/api/socket.io`)
      traefik.http.routers.socket-secure.rule: Host(`${DOMAIN}`) && PathPrefix(`/api/socket.io`)
      traefik.http.routers.socket-secure.middlewares: plugin-geoblock@file, forwardAuth-authentik@file
      # Local domain
      traefik.http.routers.socket-local-insecure.rule: (Host(`${INTERNAL_IP}`) || Host(`tipi.${LOCAL_DOMAIN}`)) && PathPrefix(`/api/socket.io`)
      # Secure
      traefik.http.routers.socket-local.rule: (Host(`${INTERNAL_IP}`) || Host(`tipi.${LOCAL_DOMAIN}`)) && PathPrefix(`/api/socket.io`)
      traefik.http.routers.socket-local.middlewares: ipAllowList-local@file
