services:
  crowdsec:
    pull_policy: missing
    ports:
      # crowdsec-bouncer-tipi
      - "8081:8080" # TODO: ${APP_PORT}:8080 #8081
    volumes: !override
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
      - ${APP_DATA_DIR}/data/crowdsec/db:/var/lib/crowdsec/data
      - ${APP_DATA_DIR}/data/crowdsec:/etc/crowdsec
    networks:
      crowdsec_falkheiland_network:
        gw_priority: 0
      tipi_main_network:
        gw_priority: 1
    environment:
      - COLLECTIONS= crowdsecurity/apache2 firix/authentik crowdsecurity/http-cve gauth-fr/immich crowdsecurity/iptables xs539/joplin-server crowdsecurity/linux crowdsecurity/sshd crowdsecurity/traefik crowdsecurity/whitelist-good-actors

  crowdsec-dashboard:
    image: metabase/metabase
    pull_policy: missing
    labels:
      # Websecure
      traefik.http.routers.crowdsec-falkheiland.middlewares: chain-Domain-auth@file
      traefik.http.routers.crowdsec-falkheiland.tls.certresolver: ''
      # WebSecure local IP
      traefik.http.routers.crowdsec-falkheiland-privip.rule: Host(`${APP_DOMAIN}`) && ClientIP(`${PRIVATE_IPV4}`)
      traefik.http.routers.crowdsec-falkheiland-privip.middlewares: chain-Domain@file
      traefik.http.routers.crowdsec-falkheiland-privip.entrypoints: websecure
      traefik.http.routers.crowdsec-falkheiland-privip.service: crowdsec-falkheiland
      traefik.http.routers.crowdsec-falkheiland-privip.priority: 100
      traefik.http.routers.crowdsec-falkheiland-privip.tls.certresolver: ''

  crowdsec-bouncer-traefik:
    pull_policy: missing
    networks:
      crowdsec_falkheiland_network:
        gw_priority: 0
      tipi_main_network:
        gw_priority: 1
